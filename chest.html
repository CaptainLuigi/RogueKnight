<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chest</title>
    <link rel="stylesheet" href="styleChest.css" />
    <link rel="stylesheet" href="styleDeckDisplay.css" />
    <script src="utility.js"></script>
    <script src="weapons.js"></script>
    <script src="baseClasses.js"></script>
    <script src="saveGame.js"></script>
    <script src="player.js"></script>
    <script src="relics.js"></script>
    <script src="music.js"></script>
  </head>
  <body>
    <div>
      <img
        id="StartscreenBackground"
        src="Assets/background_forest.png"
        alt="ForestBackground"
      />
    </div>

    <div id="pause-menu-button" title="Menu">â˜°</div>

    <div id="pause-menu" class="hidden">
      <button onclick="saveAndExit()">Save & Return to Start</button>
      <button onclick="deleteProgressAndExit()">Abandon Run</button>
      <div class="volume-info">Music Volume</div>
      <input
        type="range"
        id="music-volume-slider"
        class="volume-slider"
        min="0"
        max="1"
        step="0.01"
        value="0.5"
      />
      <div class="volume-info">SFX Volume</div>
      <input
        type="range"
        id="volume-slider"
        class="volume-slider"
        min="0"
        max="1"
        step="0.01"
        value="0.5"
      />
      <button onclick="closePauseMenu()">Close</button>
    </div>

    <button id="chest-button">
      <img id="Chest" src="Assets/Chest.png" alt="Chest" />
    </button>

    <div id="playerGold">Gold:</div>

    <div class="sprite"></div>

    <div id="relic-container"></div>

    <div id="equipped-relic-container"></div>

    <button id="addToDeck">Add</button>
    <button id="skip">Skip</button>

    <button id="current-deck" class="orange-btn">Your Deck</button>
    <div id="weapon-deck-screen" class="hidden">
      <div id="weapon-deck-container">
        <div id="weapon-list"></div>
        <button id="close-deck-btn" class="orange-btn">Close</button>
      </div>
    </div>

    <script>
      let player = new Player("Knight", 100, 100, [], 3, 3);
      player.loadPlayerFromStorage();

      document.addEventListener("DOMContentLoaded", () => {
        displayEquippedRelics();
        document
          .getElementById("current-deck")
          .addEventListener("click", () => {
            player.showDeck();
          });

        document
          .getElementById("close-deck-btn")
          .addEventListener("click", () => {
            document
              .getElementById("weapon-deck-screen")
              .classList.add("hidden");
          });

        const goldDisplay = document.getElementById("playerGold");
        goldDisplay.textContent = "Gold: " + globalSettings.playerGold;

        document
          .getElementById("chest-button")
          .addEventListener("click", openChest);
        document
          .getElementById("addToDeck")
          .addEventListener("click", addRelicToDeck);
        document.getElementById("skip").addEventListener("click", skipRelic);

        const savedRelicName = localStorage.getItem("selectedRelicName");
        if (savedRelicName) {
          const savedRelic = relicList[savedRelicName];
          if (savedRelic) {
            displaySavedRelic(savedRelic);

            const chestButton = document.getElementById("chest-button");
            chestButton.disabled = true;
            chestButton.style.cursor = "default";
          }
        }
      });

      function wait(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      const sprite = document.querySelector(".sprite");
      resetToIdleAnimation();

      /**
       * Function to open the chest and reveal a random relic.
       */
      function openChest() {
        SoundManager.play("OpenChest");

        console.log("Chest opened!");

        const chestButton = document.getElementById("chest-button");
        chestButton.disabled = true;
        chestButton.style.cursor = "default";

        const relicContainer = document.getElementById("relic-container");

        // Ensure the relic container exists before modifying it
        if (!relicContainer) {
          console.error("Relic container not found!");
          return;
        }

        // Display the buttons
        document.getElementById("addToDeck").style.display = "block";
        document.getElementById("skip").style.display = "block";

        let availableRelics = [];
        let chestRelic = globalSettings.relicGroup;

        for (let currentRelicName of relicNames) {
          const currentRelic = relicList[currentRelicName];

          // Skip relics that are not from the current chest group
          if (currentRelic.relicGroup !== chestRelic) continue;

          // Skip relics the player has already seen (skipped or equipped)
          if (player.foundRelics.includes(currentRelicName)) continue;

          availableRelics.push(currentRelicName);
        }

        // Select a random relic
        const randomRelicName =
          availableRelics[Math.floor(Math.random() * availableRelics.length)];
        const randomRelic = relicList[randomRelicName];

        localStorage.setItem("selectedRelicName", randomRelicName);

        // Clear previous relics and display new one
        relicContainer.innerHTML = "";

        const relicElement = createRelicElement(randomRelic);

        relicContainer.appendChild(relicElement);

        // Store selected relic name
        relicContainer.setAttribute("data-selected-relic", randomRelicName);
      }

      function displaySavedRelic(savedRelic) {
        const relicContainer = document.getElementById("relic-container");

        relicContainer.innerHTML = "";

        const relicElement = createRelicElement(savedRelic);
        relicContainer.appendChild(relicElement);

        relicContainer.setAttribute("data-selected-relic", savedRelic.name);

        document.getElementById("addToDeck").style.display = "block";
        document.getElementById("skip").style.display = "block";
      }

      /**
       * Function to add the selected relic to the player's inventory and update equippedRelics.
       */
      async function addRelicToDeck() {
        SoundManager.play("EquipRelic");

        await wait(850);

        const relicContainer = document.getElementById("relic-container");

        if (!relicContainer) {
          console.error("Relic container not found!");
          return;
        }

        const selectedRelicName = relicContainer.getAttribute(
          "data-selected-relic"
        );

        if (selectedRelicName) {
          const selectedRelic = relicList[selectedRelicName];

          // Add relic to equipped relics array
          player.foundRelic(selectedRelicName, true);

          // Apply relic effect
          selectedRelic.equipRelic(player);

          console.log(`Added relic: ${selectedRelicName} to equippedRelics.`);

          displayEquippedRelics();
        } else {
          console.warn("No relic selected.");
        }

        player.savePlayerToStorage();

        localStorage.removeItem("selectedRelicName");

        // Redirect to map.html
        returnToMap();
      }

      /**
       * Function to skip selecting a relic and go to map.html.
       */
      function skipRelic() {
        const relicContainer = document.getElementById("relic-container");

        const selectedRelicName = relicContainer.getAttribute(
          "data-selected-relic"
        );

        console.log("Relic skipped!");
        player.foundRelic(selectedRelicName, false);
        console.log("Current foundRelics:", player.foundRelics);
        player.savePlayerToStorage();

        localStorage.removeItem("selectedRelicName");

        // Redirect to map.html
        returnToMap();
      }

      function returnToMap() {
        localStorage.removeItem("selectedFightIndex");
        // mark event as done
        globalSettings.eventResolved = true;
        window.location.href = "map.html";
      }
    </script>
  </body>
</html>
